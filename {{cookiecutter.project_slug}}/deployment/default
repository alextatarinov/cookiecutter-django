# gunicorn django app
upstream app_server {
  server unix:/tmp/gunicorn.sock fail_timeout=0;
}

# if no Host match, close the connection to prevent host spoofing
server {
  listen 80 default_server;
  server_name _;
  return 444;
}

# remove www for http requests
server {
  listen 80;
  server_name www.example.com;
  return 301 http://example.com$request_uri;
}

# redirect all requests to SSL and remove www
#server {
#  listen 80;
#  server_name www.example.com example.com;
#  return 301 https://example.com$request_uri;
#}

# remove www for https requests
#server {
#  listen 443 ssl;
#  server_name www.example.com;
#  ssl on;
#  ssl_certificate /home/{{ cookiecutter.project_slug }}/.ssl/server.crt;
#  ssl_certificate_key /home/{{ cookiecutter.project_slug }}/.ssl/server.key;
#  return 301 https://example.com$request_uri;
#}

server {
  # for ssl
  #listen 443 ssl;
  listen 80;
 
  server_name example.com;

  access_log /home/{{ cookiecutter.project_slug }}/nginx/access.log;
  error_log /home/{{ cookiecutter.project_slug }}/nginx/error.log;


  # CAREFULLY!
  ####add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

  location / {
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Url-Scheme $scheme;
      proxy_set_header Host $http_host;
      proxy_redirect off;
      proxy_pass http://app_server;
  }

  ##
  # Media/static folders
  ##
  #location /static {    
  #      alias /home/{{ cookiecutter.project_slug }}/static/;
  #}
  #  
  #location /media {
  #      alias /home/{{ cookiecutter.project_slug }}/media/;
  #}

  # SSL
  #ssl on;
  #ssl_certificate /home/{{ cookiecutter.project_slug }}/.ssl/server.crt;
  #ssl_certificate_key /home/{{ cookiecutter.project_slug }}/.ssl/server.key;
  
  # to generate your dhparam.pem file, run in the terminal
  # openssl dhparam -out /etc/nginx/ssl/dhparam.pem 2048
  #ssl_dhparam /etc/nginx/ssl/dhparam.pem;
}
