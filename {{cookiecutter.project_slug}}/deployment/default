# gunicorn django app
upstream app_server {
  server unix:/tmp/gunicorn.sock fail_timeout=0;
}

# if no Host match, close the connection to prevent host spoofing
server {
  listen 80 default_server;
  server_name _;
  return 444;
}

# remove www for http requests
server {
  listen 80;
  server_name www.example.com;
  return 301 http://example.com$request_uri;
}

# redirect all requests to SSL and remove www
#server {
#  listen 80;
#  server_name www.example.com example.com;
#  return 301 https://example.com$request_uri;
#}

# remove www for https requests
#server {
#  listen 443 ssl;
#  server_name www.example.com;
#  ssl on;
#  ssl_certificate /home/{{project_name}}/{{project_name}}_project/.ssl/server.crt;
#  ssl_certificate_key /home/{{project_name}}/{{project_name}}_project/.ssl/server.key;
#  return 301 https://example.com$request_uri;
#}

server {
  # for ssl
  #listen 443 ssl;
  listen 80;
 
  server_name example.com;
  client_max_body_size 70m;

  access_log /home/{{project_name}}/{{project_name}}_project/nginx/access.log;
  error_log /home/{{project_name}}/{{project_name}}_project/nginx/error.log;

  add_header X-Frame-Options DENY;
  add_header X-Content-Type-Options nosniff;
  add_header X-XSS-Protection "1; mode=block";

  # CAREFULLY!
  ####add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

  location / {
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Host $http_host;
      proxy_redirect off;
      proxy_pass http://app_server;
  }

  # Media/static folders
  #location /static {    
  #      alias /home/{{project_name}}/{{project_name}}_project/static/;    
  #}
  #  
  #location /media {
  #      alias /home/{{project_name}}/{{project_name}}_project/media/;
  #}

  # SSL
  #ssl on;
  #ssl_certificate /home/{{project_name}}/{{project_name}}_project/.ssl/server.crt;
  #ssl_certificate_key /home/{{project_name}}/{{project_name}}_project/.ssl/server.key;
  
  #resolver 8.8.8.8 8.8.4.4;
  #resolver_timeout 5s;
  #ssl_stapling on; # Requires nginx >= 1.3.7
  #ssl_stapling_verify on; # Requires nginx => 1.3.7
  
  # to generate your dhparam.pem file, run in the terminal
  # openssl dhparam -out /etc/nginx/ssl/dhparam.pem 2048
  #ssl_dhparam /etc/nginx/ssl/dhparam.pem;
}
